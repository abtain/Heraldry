<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: ServerController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">ServerController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/server_controller_rb.html">
                app/controllers/server_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <h2>About</h2>
<p>
<a href="ServerController.html">ServerController</a> handles all OpenID
interchange between consumer sites and the app. It also manages the xml api
for OpenID. See <a
href="http://www.openiedenabled.com">www.openiedenabled.com</a> for more
information.
</p>
<h2>Requirements</h2>
<p>
Login is required on all actions if the request is made from a browser.
Requests from consumer sites do not require a login.
</p>
<p>
SSL is only required if the initial request is made via SSL.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000077">a_profile_was_chosen?</a>&nbsp;&nbsp;
      <a href="#M000087">add_sreg</a>&nbsp;&nbsp;
      <a href="#M000081">authorize_the_consumer_site</a>&nbsp;&nbsp;
      <a href="#M000085">check_for_human</a>&nbsp;&nbsp;
      <a href="#M000091">check_for_xml</a>&nbsp;&nbsp;
      <a href="#M000068">checkid_request?</a>&nbsp;&nbsp;
      <a href="#M000070">consumer_site_is_authorized?</a>&nbsp;&nbsp;
      <a href="#M000079">create_a_new_profile</a>&nbsp;&nbsp;
      <a href="#M000082">create_trust</a>&nbsp;&nbsp;
      <a href="#M000102">create_trust_if_necessary</a>&nbsp;&nbsp;
      <a href="#M000096">create_trust_xml</a>&nbsp;&nbsp;
      <a href="#M000065">decision</a>&nbsp;&nbsp;
      <a href="#M000094">delete_trust</a>&nbsp;&nbsp;
      <a href="#M000086">extract_identity</a>&nbsp;&nbsp;
      <a href="#M000078">find_the_profile</a>&nbsp;&nbsp;
      <a href="#M000088">format_sreg</a>&nbsp;&nbsp;
      <a href="#M000103">get_params_from_xml</a>&nbsp;&nbsp;
      <a href="#M000064">index</a>&nbsp;&nbsp;
      <a href="#M000075">inform_the_consumer_site</a>&nbsp;&nbsp;
      <a href="#M000105">inform_the_xml_agent</a>&nbsp;&nbsp;
      <a href="#M000095">is_create_trust?</a>&nbsp;&nbsp;
      <a href="#M000093">is_delete_trust?</a>&nbsp;&nbsp;
      <a href="#M000097">is_profile_list?</a>&nbsp;&nbsp;
      <a href="#M000099">is_query_profile?</a>&nbsp;&nbsp;
      <a href="#M000092">is_xml_request?</a>&nbsp;&nbsp;
      <a href="#M000074">log_the_action</a>&nbsp;&nbsp;
      <a href="#M000101">login_user</a>&nbsp;&nbsp;
      <a href="#M000076">redirect_user_to_create_new_authorization</a>&nbsp;&nbsp;
      <a href="#M000090">render_response</a>&nbsp;&nbsp;
      <a href="#M000089">render_trust_request</a>&nbsp;&nbsp;
      <a href="#M000104">render_xml_response</a>&nbsp;&nbsp;
      <a href="#M000071">request_is_checkid_immediate?</a>&nbsp;&nbsp;
      <a href="#M000072">request_is_checkid_setup?</a>&nbsp;&nbsp;
      <a href="#M000080">set_flash_error_message</a>&nbsp;&nbsp;
      <a href="#M000083">set_req</a>&nbsp;&nbsp;
      <a href="#M000069">set_required_and_optional_fields</a>&nbsp;&nbsp;
      <a href="#M000067">trust_profile_chosen?</a>&nbsp;&nbsp;
      <a href="#M000066">trust_request_param_exists?</a>&nbsp;&nbsp;
      <a href="#M000073">user_owns_identity_url?</a>&nbsp;&nbsp;
      <a href="#M000084">verify_current_user_owns_identity_url</a>&nbsp;&nbsp;
      <a href="#M000098">xml_profile_list</a>&nbsp;&nbsp;
      <a href="#M000100">xml_query_profile</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">OPENID_SREG_GENDER</td>
          <td>=</td>
          <td class="context-item-value">{'male' =&gt; 'm', 'female' =&gt; 'f'}</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
The conversion parameters for OpenID gender.

</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">decision</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Process the <a href="User.html">User</a>&#8217;s decision on an
openid.checkid_setup request.
</p>
<h4>params</h4>
<table>
<tr><td valign="top">query:</td><td>Original openid query string.

</td></tr>
<tr><td valign="top">trust_profile:</td><td>Trust#id of the trust profile being used. Use -1 if a new trust_profile is
being created.

</td></tr>
<tr><td valign="top">profile_name:</td><td>Name of the new <a href="Profile.html">Profile</a> (if one is being
created).

</td></tr>
<tr><td valign="top">property:</td><td>Array of property ids to use with the <a href="Profile.html">Profile</a>
(if one is being created).

</td></tr>
<tr><td valign="top">keep_until:</td><td>The length of time to for the <a href="Trust.html">Trust</a> to be active.
Accepted values: &#8216;forever&#8217;, &#8216;exact&#8217;,
&#8216;once&#8217;.

</td></tr>
<tr><td valign="top">date:</td><td>The exact date at which the <a href="Trust.html">Trust</a> expires. A hash
of three self explanatory keys: :year =&gt; yyyy, :month =&gt; mm, &amp;
:day =&gt; dd.

</td></tr>
<tr><td valign="top">yes.y:</td><td>If this contains a value, then the user approved the trust_request.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 76</span>
76:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">decision</span> 
77:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">trust_request_param_exists?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">trust_profile_chosen?</span>
78: 
79:     <span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-constant">CGIMethods</span>.<span class="ruby-identifier">parse_query_parameters</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:query</span>])
80:     <span class="ruby-identifier">set_req</span>
81:     <span class="ruby-identifier">set_required_and_optional_fields</span>
82:     <span class="ruby-identifier">authorize_the_consumer_site</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">consumer_site_is_authorized?</span>
83:     <span class="ruby-identifier">inform_the_consumer_site</span>(<span class="ruby-identifier">:it_is_authorized</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">performed?</span>
84:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The primary point of entry for all outside contact with server controller.
Handles three types of requests: one from consumer sites, one from users at
a browser, and a third from the xml api.
</p>
<h4>Consumer sites</h4>
<p>
Consumer sites make requests to initiate associations and verify
association data. These requests do not require a login or ssl.
</p>
<h4><a href="User.html">User</a> requests</h4>
<p>
These requests are redirects from a consumer site that determine if the
consumer site is allowed access to the user&#8217;s information.
</p>
<h4>XML requests</h4>
<p>
These are similar to user requests except make use of the XML api. In
addition, there is additional functionality for creating trusts.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 41</span>
41:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
42:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;This is an OpenID server endpoint.&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@req</span>
43: 
44:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">checkid_request?</span>
45:       <span class="ruby-identifier">set_required_and_optional_fields</span>
46:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">consumer_site_is_authorized?</span>
47:         <span class="ruby-identifier">log_the_action</span>
48:         <span class="ruby-identifier">inform_the_consumer_site</span> <span class="ruby-identifier">:it_is_authorized</span>
49:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">is_xml_request?</span>
50:         <span class="ruby-identifier">inform_the_xml_agent</span> <span class="ruby-identifier">:it_is_not_authorized</span>
51:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">request_is_checkid_immediate?</span>
52:         <span class="ruby-identifier">inform_the_consumer_site</span> <span class="ruby-identifier">:it_is_not_authorized</span>
53:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">request_is_checkid_setup?</span>
54:         <span class="ruby-identifier">redirect_user_to_create_new_authorization</span>
55:       <span class="ruby-keyword kw">else</span>
56:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">'The chain should not have gotten this far in Server#index'</span>
57:       <span class="ruby-keyword kw">end</span>
58:     <span class="ruby-keyword kw">else</span> <span class="ruby-comment cmt"># Must be an association request</span>
59:       <span class="ruby-identifier">inform_the_consumer_site</span> <span class="ruby-identifier">:it_has_an_association</span>
60:     <span class="ruby-keyword kw">end</span>
61:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Protected Instance methods</h3>

      <div id="method-M000077" class="method-detail">
        <a name="M000077"></a>

        <div class="method-heading">
          <a href="#M000077" class="method-signature">
          <span class="method-name">a_profile_was_chosen?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000077-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000077-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 174</span>
174:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">a_profile_was_chosen?</span>
175:     <span class="ruby-operator">!</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:trust_profile</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'-1'</span>)
176:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000087" class="method-detail">
        <a name="M000087"></a>

        <div class="method-heading">
          <a href="#M000087" class="method-signature">
          <span class="method-name">add_sreg</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds the requested profile data to the openid query string.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">required:</td><td>An array of required fields.

</td></tr>
<tr><td valign="top">optional:</td><td>An array of optional fields.

</td></tr>
<tr><td valign="top">response:</td><td>The openid response the fields are being added to.

</td></tr>
<tr><td valign="top">profile:</td><td>The profile data is retrieved from.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000087-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000087-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 287</span>
287:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_sreg</span>
288:     <span class="ruby-identifier">sreg</span> = {}
289:     <span class="ruby-identifier">fields</span> = (<span class="ruby-ivar">@required_fields</span> <span class="ruby-operator">||</span> []) <span class="ruby-operator">+</span> (<span class="ruby-ivar">@optional_fields</span> <span class="ruby-operator">||</span> [])
290:     <span class="ruby-identifier">openid</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">openid</span>
291:     <span class="ruby-identifier">profile</span> = <span class="ruby-ivar">@trust</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">profile</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
292:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">profile</span>.<span class="ruby-identifier">nil?</span>
293:       <span class="ruby-identifier">fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span>
294:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">property</span> = <span class="ruby-identifier">profile</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;value_for_#{openid[field]}&quot;</span>)
295:           <span class="ruby-identifier">sreg</span>[<span class="ruby-identifier">field</span>] = <span class="ruby-identifier">format_sreg</span>(<span class="ruby-identifier">property</span>, <span class="ruby-identifier">field</span>)
296:         <span class="ruby-keyword kw">end</span>
297:       <span class="ruby-keyword kw">end</span>
298:     <span class="ruby-keyword kw">end</span>
299:     
300:     <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">add_fields</span>(<span class="ruby-value str">'sreg'</span>, <span class="ruby-identifier">sreg</span>)  
301:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000081" class="method-detail">
        <a name="M000081"></a>

        <div class="method-heading">
          <a href="#M000081" class="method-signature">
          <span class="method-name">authorize_the_consumer_site</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000081-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000081-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 202</span>
202:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">authorize_the_consumer_site</span>
203:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">a_profile_was_chosen?</span>
204:       <span class="ruby-identifier">find_the_profile</span>
205:     <span class="ruby-keyword kw">else</span>
206:       <span class="ruby-identifier">create_a_new_profile</span>
207:     <span class="ruby-keyword kw">end</span>
208:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@profile</span>
209:       <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-identifier">:error</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Invalid Profile'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>]
210:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render_trust_request</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:query</span>])
211:     <span class="ruby-keyword kw">end</span>
212: 
213:     <span class="ruby-identifier">create_trust</span>
214:     <span class="ruby-identifier">log_the_action</span>
215:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000085" class="method-detail">
        <a name="M000085"></a>

        <div class="method-heading">
          <a href="#M000085" class="method-signature">
          <span class="method-name">check_for_human</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
If the request is coming from a user at a browser, require the user to
login.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000085-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000085-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 252</span>
252:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_human</span>
253:     <span class="ruby-identifier">set_req</span>
254:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:previous_protocol</span>] = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">protocol</span>
255:     <span class="ruby-identifier">login_required</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span><span class="ruby-operator">::</span><span class="ruby-constant">CheckIDRequest</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'checkid_setup'</span>
256:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000091" class="method-detail">
        <a name="M000091"></a>

        <div class="method-heading">
          <a href="#M000091" class="method-signature">
          <span class="method-name">check_for_xml</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Stops the filter chain if the request is meant for the XML api.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000091-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000091-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 379</span>
379:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_for_xml</span> 
380:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">is_xml_request?</span> 
381:     <span class="ruby-keyword kw">return</span>(<span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;Error: bad xml&lt;/Response&gt;'</span>)) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>].<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">empty?</span> 
382: 
383:     <span class="ruby-comment cmt"># headers['Content-Type'], NOT headers['CONTENT_TYPE'] </span>
384:     <span class="ruby-ivar">@response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'CONTENT_TYPE'</span>] = <span class="ruby-value str">'text/xml; charset=utf-8'</span> 
385:     <span class="ruby-ivar">@response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Type'</span>] = <span class="ruby-value str">'text/xml; charset=utf-8'</span> 
386: 
387:     <span class="ruby-identifier">xml</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>]) 
388:     <span class="ruby-identifier">login_user</span>(<span class="ruby-identifier">xml</span>) 
389:     <span class="ruby-keyword kw">return</span>(<span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;bad username or password&lt;/Response&gt;'</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span> 
390: 
391:     <span class="ruby-keyword kw">begin</span> 
392:       (<span class="ruby-identifier">delete_trust</span>(<span class="ruby-identifier">xml</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_delete_trust?</span> 
393:       (<span class="ruby-identifier">create_trust_xml</span>(<span class="ruby-identifier">xml</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_create_trust?</span> 
394:       (<span class="ruby-identifier">xml_profile_list</span>(<span class="ruby-identifier">xml</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_profile_list?</span> 
395:       (<span class="ruby-identifier">xml_query_profile</span>(<span class="ruby-identifier">xml</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_query_profile?</span> 
396: 
397:       <span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">get_params_from_xml</span>(<span class="ruby-identifier">xml</span>)) 
398: 
399:                  <span class="ruby-identifier">create_trust_if_necessary</span>(<span class="ruby-identifier">xml</span>) 
400:                <span class="ruby-keyword kw">rescue</span> 
401:             <span class="ruby-keyword kw">return</span>(<span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;Error: bad xml format.&lt;/Response&gt;'</span>)) 
402:     <span class="ruby-keyword kw">end</span>
403:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">checkid_request?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 105</span>
105:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">checkid_request?</span>
106:     <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span><span class="ruby-operator">::</span><span class="ruby-constant">CheckIDRequest</span>
107:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">consumer_site_is_authorized?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the user is logged in and owns the trust_root.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">url:</td><td>The <a href="User.html">User</a>&#8217;s identity url.

</td></tr>
<tr><td valign="top">trust_root:</td><td>The consumer site&#8217;s trust root.

</td></tr>
<tr><td valign="top">required_properties:</td><td>An array of properties the <a href="Profile.html">Profile</a> must have. !
NOT CURRENTLY USED !

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 123</span>
123:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">consumer_site_is_authorized?</span>
124:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>
125:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">user_owns_identity_url?</span>
126:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">trust</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">trusts</span>.<span class="ruby-identifier">find_by_trust_root</span>(<span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">trust</span>.<span class="ruby-identifier">active?</span>
127:     <span class="ruby-keyword kw">end</span>
128:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
129:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000079" class="method-detail">
        <a name="M000079"></a>

        <div class="method-heading">
          <a href="#M000079" class="method-signature">
          <span class="method-name">create_a_new_profile</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000079-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000079-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 182</span>
182:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_a_new_profile</span>
183:     <span class="ruby-ivar">@profile</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:profile_name</span>])
184:     <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">add_properties</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:property</span>])
185:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">save</span> <span class="ruby-operator">||</span> ((<span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:profile_name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:profile_name</span>].<span class="ruby-identifier">empty?</span>) <span class="ruby-operator">&amp;&amp;</span>
186:                               <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:keep_until</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'once'</span>)
187:       <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">reload</span>
188:       <span class="ruby-identifier">set_flash_error_message</span>
189:       <span class="ruby-ivar">@profile</span> = <span class="ruby-keyword kw">nil</span>
190:     <span class="ruby-keyword kw">end</span>
191:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000082" class="method-detail">
        <a name="M000082"></a>

        <div class="method-heading">
          <a href="#M000082" class="method-signature">
          <span class="method-name">create_trust</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000082-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000082-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 217</span>
217:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_trust</span>
218:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:keep_until</span>]
219:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'forever'</span>  
220:       <span class="ruby-identifier">expires_at</span> = <span class="ruby-keyword kw">nil</span>
221:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'exact'</span>
222:       <span class="ruby-identifier">expires_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">gm</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date</span>][<span class="ruby-identifier">:year</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date</span>][<span class="ruby-identifier">:month</span>], <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date</span>][<span class="ruby-identifier">:day</span>]).<span class="ruby-identifier">utc</span>
223:     <span class="ruby-keyword kw">end</span>
224:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@trust</span> = <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">trusts</span>.<span class="ruby-identifier">find_by_trust_root</span>(<span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>)
225:       <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@profile</span>, <span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">expires_at</span>)
226:     <span class="ruby-keyword kw">else</span>
227:       <span class="ruby-ivar">@trust</span> = <span class="ruby-constant">Trust</span>.<span class="ruby-identifier">create</span> <span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@profile</span>, <span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">expires_at</span>, <span class="ruby-identifier">:trust_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>
228:     <span class="ruby-keyword kw">end</span>
229:     <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:keep_until</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'once'</span>
230:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000102" class="method-detail">
        <a name="M000102"></a>

        <div class="method-heading">
          <a href="#M000102" class="method-signature">
          <span class="method-name">create_trust_if_necessary</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a one use trust if necessary for the given trust_root.
</p>
<h3>Parameters</h3>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000102-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000102-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 534</span>
534:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_trust_if_necessary</span>(<span class="ruby-identifier">xml</span>) 
535:     <span class="ruby-identifier">profile_name</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Request'</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'AccessProfile'</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">text</span> 
536:     <span class="ruby-identifier">profile_name</span> = <span class="ruby-value str">'public'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">profile_name</span> 
537:     <span class="ruby-identifier">profile</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-identifier">profile_name</span>) 
538:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">profile</span> 
539:     <span class="ruby-identifier">hsh</span> = {<span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">profile</span>} 
540:     <span class="ruby-identifier">params</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">get_params_from_xml</span>(<span class="ruby-identifier">xml</span>)) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.mode'</span>] 
541:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@trust</span> = <span class="ruby-constant">Trust</span>.<span class="ruby-identifier">find_by_trust_root</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.trust_root'</span>]) 
542:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">active?</span> 
543:         <span class="ruby-identifier">hsh</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>)  
544:         <span class="ruby-identifier">just_once</span> = <span class="ruby-keyword kw">true</span> 
545:       <span class="ruby-keyword kw">end</span> 
546:       <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">hsh</span>) 
547:     <span class="ruby-keyword kw">else</span> 
548:       <span class="ruby-ivar">@trust</span> = <span class="ruby-constant">Trust</span>.<span class="ruby-identifier">create</span> <span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">profile</span>, <span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">:trust_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.trust_root'</span>] 
549:       <span class="ruby-identifier">just_once</span> = <span class="ruby-keyword kw">true</span> 
550:     <span class="ruby-keyword kw">end</span> 
551:     <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">instance_eval</span> <span class="ruby-node">&quot;def xml_expire?; #{just_once}; end&quot;</span> 
552:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000096" class="method-detail">
        <a name="M000096"></a>

        <div class="method-heading">
          <a href="#M000096" class="method-signature">
          <span class="method-name">create_trust_xml</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses and executes a create trust command.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000096-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000096-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 448</span>
448:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_trust_xml</span>(<span class="ruby-identifier">xml</span>) 
449:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span> 
450:       <span class="ruby-identifier">empty</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Element</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'empty'</span>) 
451:       <span class="ruby-identifier">trust</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Trust'</span>).<span class="ruby-identifier">first</span> 
452:      
453:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&lt;Response&gt;bad xml&lt;/Response&gt;&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">trust</span> 
454:       <span class="ruby-identifier">trust_root</span> = (<span class="ruby-identifier">trust</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'TrustRoot'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> 
455:       <span class="ruby-identifier">expires</span> = (<span class="ruby-identifier">trust</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Expires'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> 
456:       <span class="ruby-identifier">profile_name</span> = (<span class="ruby-identifier">trust</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'AccessProfile'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> 
457:       <span class="ruby-identifier">profile_name</span> = <span class="ruby-value str">'public'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">profile_name</span> 
458:       <span class="ruby-ivar">@profile</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-identifier">profile_name</span>) 
459:        
460:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&lt;Response&gt;bad profile&lt;/Response&gt;&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@profile</span> 
461:        
462:       <span class="ruby-keyword kw">if</span> [<span class="ruby-value str">'-1'</span>, <span class="ruby-value str">'0'</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">expires</span> 
463:         <span class="ruby-identifier">expires_at</span> = <span class="ruby-keyword kw">nil</span> 
464:       <span class="ruby-keyword kw">else</span> 
465:         <span class="ruby-identifier">expires</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[(\d+)/(\d+)/(\d+)]</span> 
466:         <span class="ruby-identifier">expires_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">utc</span>(<span class="ruby-identifier">$3</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">$2</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">to_i</span>) 
467:       <span class="ruby-keyword kw">end</span> 
468:        
469:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@trust</span> = <span class="ruby-constant">Trust</span>.<span class="ruby-identifier">find_by_trust_root</span>(<span class="ruby-identifier">trust_root</span>) 
470:         <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@profile</span>, <span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">expires_at</span>) 
471:       <span class="ruby-keyword kw">else</span> 
472:         <span class="ruby-ivar">@trust</span> = <span class="ruby-constant">Trust</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">:profile</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@profile</span>, <span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">expires_at</span>, <span class="ruby-identifier">:trust_root</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">trust_root</span>) 
473:       <span class="ruby-keyword kw">end</span> 
474:       <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">expires</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'0'</span> 
475:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;success&lt;/Response&gt;'</span>) 
476:     <span class="ruby-keyword kw">end</span> 
477:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;could not create trust&lt;/Response&gt;'</span> 
478:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000094" class="method-detail">
        <a name="M000094"></a>

        <div class="method-heading">
          <a href="#M000094" class="method-signature">
          <span class="method-name">delete_trust</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses and executes a delete trust command.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000094-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000094-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 423</span>
423:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_trust</span>(<span class="ruby-identifier">xml</span>) 
424:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span> 
425:       <span class="ruby-identifier">trust_root</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'TrustRoot'</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">text</span> 
426:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">trust_root</span>.<span class="ruby-identifier">empty?</span> 
427:         <span class="ruby-ivar">@trust</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">trusts</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'trust_root = ?'</span>, <span class="ruby-identifier">trust_root</span>]) 
428:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@trust</span> 
429:           <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">destroy</span> 
430:           <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&lt;Response&gt;success&lt;/Response&gt;&quot;</span>) 
431:         <span class="ruby-keyword kw">end</span> 
432:       <span class="ruby-keyword kw">end</span> 
433:     <span class="ruby-keyword kw">end</span> 
434:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;trust root does not exist&lt;/Response&gt;'</span> 
435:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000086" class="method-detail">
        <a name="M000086"></a>

        <div class="method-heading">
          <a href="#M000086" class="method-signature">
          <span class="method-name">extract_identity</span><span class="method-args">(uri)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets the username from an identity string <a
href="ServerController.html#M000086">extract_identity</a>(&#8216;<a
href="http://user.idp.com">user.idp.com</a>&#8217;) =&gt;
&#8216;user&#8217; <a
href="ServerController.html#M000086">extract_identity</a>(&#8216;<a
href="http://idp.com/user/user_login">idp.com/user/user_login</a>&#8217;)
=&gt; &#8216;user_login&#8216;
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000086-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000086-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 267</span>
267:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">extract_identity</span>(<span class="ruby-identifier">uri</span>)
268:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">uri</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[/user/([a-zA-Z_1-9]*)]</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">uri</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[://([a-zA-Z_1-9]*)?\.]</span>
269:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
270:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000078" class="method-detail">
        <a name="M000078"></a>

        <div class="method-heading">
          <a href="#M000078" class="method-signature">
          <span class="method-name">find_the_profile</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000078-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000078-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 178</span>
178:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_the_profile</span>
179:     <span class="ruby-ivar">@profile</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:trust_profile</span>])
180:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000088" class="method-detail">
        <a name="M000088"></a>

        <div class="method-heading">
          <a href="#M000088" class="method-signature">
          <span class="method-name">format_sreg</span><span class="method-args">(property, sreg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Format a property value to match the format required by OpenID.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">property:</td><td><a href="Property.html#M000110">Property#value</a>

</td></tr>
<tr><td valign="top">sreg:</td><td>The lowercase sreg parameter. i.e. - &#8216;dob&#8217; or
&#8216;gender&#8217;

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000088-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000088-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 312</span>
312:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">format_sreg</span>(<span class="ruby-identifier">property</span>, <span class="ruby-identifier">sreg</span>)
313:     <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">property</span>
314:     
315:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">sreg</span>.<span class="ruby-identifier">downcase</span>
316:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'dob'</span>
317:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">property</span>.<span class="ruby-identifier">to_s</span>
318:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'gender'</span>
319:       <span class="ruby-keyword kw">return</span> <span class="ruby-constant">OPENID_SREG_GENDER</span>[<span class="ruby-identifier">property</span>.<span class="ruby-identifier">downcase</span>] <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>
320:     <span class="ruby-comment cmt"># Hacky way to handle american timezones</span>
321:     <span class="ruby-comment cmt"># TODO: Make this not so hacky. Maybe use a model to convey idea of timezone.</span>
322:     <span class="ruby-comment cmt"># This really isn't something that should exist within ServerController.</span>
323:     <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'timezone'</span>
324:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">property</span>
325:       <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'us_eastern'</span>
326:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'America/New_York'</span>
327:       <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'us_central'</span>
328:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'America/Chicago'</span>
329:       <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'us_mountain'</span>
330:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'America/Denver'</span>
331:       <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'us_pacific'</span>
332:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'America/Los_Angeles'</span>
333:       <span class="ruby-keyword kw">else</span>
334:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">property</span>
335:       <span class="ruby-keyword kw">end</span>
336:     <span class="ruby-keyword kw">else</span>
337:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">property</span>
338:     <span class="ruby-keyword kw">end</span>
339:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000103" class="method-detail">
        <a name="M000103"></a>

        <div class="method-heading">
          <a href="#M000103" class="method-signature">
          <span class="method-name">get_params_from_xml</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Extracts OpenID params from an xml request and returns them as a hash.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>Raw xml post data.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000103-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000103-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 557</span>
557:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_params_from_xml</span>(<span class="ruby-identifier">xml</span>) 
558:     <span class="ruby-identifier">empty</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Element</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'empty'</span>) 
559:     <span class="ruby-identifier">empty_attr</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Attribute</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'empty'</span>) 
560:     <span class="ruby-identifier">ret</span> = {} 
561:     <span class="ruby-identifier">root</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span> 
562:  
563:     <span class="ruby-identifier">ret</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'openid.mode'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;checkid_#{$1.downcase}&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">root</span>.<span class="ruby-identifier">xpath</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/OpenIDCheckID(.*)/</span> 
564:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Request'</span>).<span class="ruby-identifier">first</span> 
565:       <span class="ruby-identifier">ret</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'openid.identity'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">req</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Identity'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>, 
566:                  <span class="ruby-value str">'openid.assoc_handle'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">req</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'AssocHandle'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>, 
567:                  <span class="ruby-value str">'openid.return_to'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">req</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'ReturnTo'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span>  <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>, 
568:                  <span class="ruby-value str">'openid.trust_root'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">req</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'TrustRoot'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>) 
569:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">sreg</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Sreg'</span>).<span class="ruby-identifier">first</span> 
570:         <span class="ruby-identifier">ret</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'openid.sreg.required'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">sreg</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-value str">'required'</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">empty_attr</span>).<span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>, 
571:                    <span class="ruby-value str">'openid.sreg.optional'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">sreg</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-value str">'optional'</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">empty_attr</span>).<span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>, 
572:                    <span class="ruby-value str">'openid.sreg.policy_url'</span> =<span class="ruby-operator">&gt;</span> ((<span class="ruby-identifier">sreg</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-value str">'policy_url'</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">empty_attr</span>).<span class="ruby-identifier">value</span> <span class="ruby-operator">||</span> <span class="ruby-value str">''</span>).<span class="ruby-identifier">strip</span>) 
573:       <span class="ruby-keyword kw">end</span> 
574:     <span class="ruby-keyword kw">end</span> 
575:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ret</span> 
576:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">inform_the_consumer_site</span><span class="method-args">(action)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 149</span>
149:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inform_the_consumer_site</span>(<span class="ruby-identifier">action</span>)
150:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">action</span>
151:     <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:it_is_authorized</span>
152:       <span class="ruby-ivar">@trust</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">trusts</span>.<span class="ruby-identifier">find_by_trust_root</span>(<span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>)
153:       <span class="ruby-ivar">@resp</span> = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">answer</span>(<span class="ruby-keyword kw">true</span>)
154:       <span class="ruby-identifier">add_sreg</span>
155:     <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:it_is_not_authorized</span>
156:       <span class="ruby-identifier">retry_query</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">nil?</span>}
157:       <span class="ruby-identifier">retry_query</span>[<span class="ruby-value str">'openid.mode'</span>] = <span class="ruby-value str">'checkid_setup'</span>
158:       <span class="ruby-identifier">setup_url</span> = <span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Util</span>.<span class="ruby-identifier">append_args</span>(<span class="ruby-identifier">server_url</span>(<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'index'</span>), <span class="ruby-identifier">retry_query</span>)
159:             <span class="ruby-ivar">@resp</span> = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">answer</span>(<span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">setup_url</span>)
160:       <span class="ruby-comment cmt"># Hackery to circumvent JanRain library bug in req.answer.</span>
161:       <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">fields</span>[<span class="ruby-value str">'user_setup_url'</span>] = <span class="ruby-identifier">setup_url</span> 
162:     <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:it_has_an_association</span>
163:       <span class="ruby-ivar">@resp</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">handle_request</span>(<span class="ruby-ivar">@req</span>)
164:     <span class="ruby-keyword kw">else</span>
165:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Bad action: #{action}&quot;</span>
166:     <span class="ruby-keyword kw">end</span>
167:     <span class="ruby-identifier">render_response</span>
168:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000105" class="method-detail">
        <a name="M000105"></a>

        <div class="method-heading">
          <a href="#M000105" class="method-signature">
          <span class="method-name">inform_the_xml_agent</span><span class="method-args">(action)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000105-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000105-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 589</span>
589:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">inform_the_xml_agent</span>(<span class="ruby-identifier">action</span>)
590:     <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">action</span>
591:     <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:it_is_not_authorized</span>
592:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request_is_checkid_immediate?</span>
593:         <span class="ruby-identifier">setup_url</span> = <span class="ruby-identifier">server_url</span>(<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'index'</span>)
594:         <span class="ruby-ivar">@resp</span> = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">answer</span>(<span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">setup_url</span>)
595:       <span class="ruby-keyword kw">else</span>
596:         <span class="ruby-ivar">@resp</span> = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">answer</span>(<span class="ruby-keyword kw">false</span>)
597:       <span class="ruby-keyword kw">end</span>
598:     <span class="ruby-keyword kw">else</span>
599:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Bad action: #{action}&quot;</span>
600:     <span class="ruby-keyword kw">end</span>
601:     <span class="ruby-identifier">render_response</span>
602:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000095" class="method-detail">
        <a name="M000095"></a>

        <div class="method-heading">
          <a href="#M000095" class="method-signature">
          <span class="method-name">is_create_trust?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if this is an xml request to delete a trust.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000095-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000095-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 438</span>
438:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_create_trust?</span> 
439:     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[&lt;CreateTrust&gt;]</span> 
440:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000093" class="method-detail">
        <a name="M000093"></a>

        <div class="method-heading">
          <a href="#M000093" class="method-signature">
          <span class="method-name">is_delete_trust?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if this is an xml request to delete a trust.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000093-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000093-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 413</span>
413:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_delete_trust?</span> 
414:     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[&lt;DeleteTrust&gt;]</span> 
415:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000097" class="method-detail">
        <a name="M000097"></a>

        <div class="method-heading">
          <a href="#M000097" class="method-signature">
          <span class="method-name">is_profile_list?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if this is an xml request to show a list of available
profiles.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000097-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000097-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 481</span>
481:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_profile_list?</span> 
482:     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[&lt;QueryProfileList&gt;]</span> 
483:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000099" class="method-detail">
        <a name="M000099"></a>

        <div class="method-heading">
          <a href="#M000099" class="method-signature">
          <span class="method-name">is_query_profile?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if this is an xml request to query a profile.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000099-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000099-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 499</span>
499:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_query_profile?</span> 
500:     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'RAW_POST_DATA'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[&lt;QueryProfile&gt;]</span> 
501:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000092" class="method-detail">
        <a name="M000092"></a>

        <div class="method-heading">
          <a href="#M000092" class="method-signature">
          <span class="method-name">is_xml_request?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if this is an xml request.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000092-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000092-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 408</span>
408:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">is_xml_request?</span> 
409:     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'Content-Type'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[text/xml]</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'CONTENT_TYPE'</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">%r[text/xml]</span> 
410:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">log_the_action</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 144</span>
144:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">log_the_action</span>
145:     <span class="ruby-constant">Ledger</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">:source</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>, <span class="ruby-identifier">:event</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Trust Request'</span>, <span class="ruby-identifier">:target</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">identity_url</span>,
146:                   <span class="ruby-identifier">:source_ip</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>, <span class="ruby-identifier">:login</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>, <span class="ruby-identifier">:result</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'Authorized'</span>)
147:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000101" class="method-detail">
        <a name="M000101"></a>

        <div class="method-heading">
          <a href="#M000101" class="method-signature">
          <span class="method-name">login_user</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Login the user via an xml request
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000101-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000101-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 524</span>
524:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">login_user</span>(<span class="ruby-identifier">xml</span>) 
525:     <span class="ruby-identifier">login</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'User'</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">text</span> 
526:     <span class="ruby-identifier">password</span> = <span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'Password'</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">text</span> 
527:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">current_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">authenticate</span>(<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>) 
528:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000076" class="method-detail">
        <a name="M000076"></a>

        <div class="method-heading">
          <a href="#M000076" class="method-signature">
          <span class="method-name">redirect_user_to_create_new_authorization</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000076-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000076-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 170</span>
170:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">redirect_user_to_create_new_authorization</span>
171:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render_trust_request</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'QUERY_STRING'</span>])
172:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000090" class="method-detail">
        <a name="M000090"></a>

        <div class="method-heading">
          <a href="#M000090" class="method-signature">
          <span class="method-name">render_response</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Renders the redirect response for an OpenID request.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">response:</td><td>An OpenID::Server::OpenIDResponse object.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000090-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000090-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 361</span>
361:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_response</span>
362:     <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Type'</span>] = <span class="ruby-value str">'charset=utf-8'</span>
363:     <span class="ruby-ivar">@resp</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">encode_response</span>(<span class="ruby-ivar">@resp</span>)
364:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render_xml_response</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_xml_request?</span>
365:     <span class="ruby-keyword kw">case</span> <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">code</span>
366:     <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_OK</span>
367:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">body</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">200</span>
368:     <span class="ruby-keyword kw">when</span> <span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP_REDIRECT</span>
369:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">redirect_url</span>
370:     <span class="ruby-keyword kw">else</span>
371:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@resp</span>.<span class="ruby-identifier">body</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">400</span>
372:     <span class="ruby-keyword kw">end</span>   
373:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000089" class="method-detail">
        <a name="M000089"></a>

        <div class="method-heading">
          <a href="#M000089" class="method-signature">
          <span class="method-name">render_trust_request</span><span class="method-args">(query_string)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Renders the trust request page.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">req:</td><td>The OpenID::Server::CheckIDRequest object.

</td></tr>
<tr><td valign="top">required_fields:</td><td>An array of required fields.

</td></tr>
<tr><td valign="top">optional_fields:</td><td>An array of optional fields.

</td></tr>
<tr><td valign="top">query_string:</td><td>The original openid query_string.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000089-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000089-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 347</span>
347:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_trust_request</span>(<span class="ruby-identifier">query_string</span>)
348:     <span class="ruby-ivar">@required_fields</span>.<span class="ruby-identifier">map!</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">openid</span>[<span class="ruby-identifier">f</span>] }
349:     <span class="ruby-ivar">@optional_fields</span>.<span class="ruby-identifier">map!</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">openid</span>[<span class="ruby-identifier">f</span>] }
350:     <span class="ruby-ivar">@openid_map</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">openid</span>
351:     <span class="ruby-ivar">@properties</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">delete_if</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span>(<span class="ruby-ivar">@required_fields</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@optional_fields</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">p</span>.<span class="ruby-identifier">property_type</span>.<span class="ruby-identifier">short_name</span>)}
352:     <span class="ruby-ivar">@trust_root</span>      = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">trust_root</span>
353:     <span class="ruby-ivar">@identity_url</span>    = <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">identity_url</span>
354:     <span class="ruby-ivar">@query_string</span>    = <span class="ruby-identifier">query_string</span>
355:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'trust_request'</span>, <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'application'</span>)
356:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000104" class="method-detail">
        <a name="M000104"></a>

        <div class="method-heading">
          <a href="#M000104" class="method-signature">
          <span class="method-name">render_xml_response</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Render a response to an xml request. Response is rendered in xml.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">resp:</td><td>An OpenID::Response object.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000104-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000104-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 582</span>
582:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_xml_response</span> 
583:     <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">:expires_at</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@trust</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@trust</span>.<span class="ruby-identifier">xml_expire?</span> 
584:     <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'CONTENT_TYPE'</span>] = <span class="ruby-value str">'text/xml; charset=utf-8'</span> 
585:     <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Type'</span>] = <span class="ruby-value str">'text/xml; charset=utf-8'</span> 
586:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;Response&gt;#{@resp.headers['location'].gsub(/&amp;/,'&amp;#38;')}&lt;/Response&gt;&quot;</span> 
587:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">request_is_checkid_immediate?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 131</span>
131:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">request_is_checkid_immediate?</span>
132:     <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">immediate</span>
133:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">request_is_checkid_setup?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 135</span>
135:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">request_is_checkid_setup?</span>
136:     <span class="ruby-operator">!</span><span class="ruby-ivar">@req</span>.<span class="ruby-identifier">immediate</span>
137:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000080" class="method-detail">
        <a name="M000080"></a>

        <div class="method-heading">
          <a href="#M000080" class="method-signature">
          <span class="method-name">set_flash_error_message</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000080-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000080-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 193</span>
193:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_flash_error_message</span>
194:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'Title can\'t be blank'</span>)
195:       <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-identifier">:error</span>] = <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Title can\'t be blank'</span>} <span class="ruby-operator">&lt;&lt;</span>
196:                           <span class="ruby-value str">'Please choose or create a trust profile.'</span>
197:     <span class="ruby-keyword kw">else</span>
198:       <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-identifier">:error</span>] = <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>
199:     <span class="ruby-keyword kw">end</span>
200:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000083" class="method-detail">
        <a name="M000083"></a>

        <div class="method-heading">
          <a href="#M000083" class="method-signature">
          <span class="method-name">set_req</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000083-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000083-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 232</span>
232:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_req</span>
233:     <span class="ruby-ivar">@req</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">decode_request</span>(<span class="ruby-identifier">params</span>.<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span> <span class="ruby-identifier">val</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>})
234:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">set_required_and_optional_fields</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 109</span>
109:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_required_and_optional_fields</span>
110:     <span class="ruby-ivar">@required_fields</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.sreg.required'</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.sreg.required'</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>) <span class="ruby-operator">:</span> []
111:     <span class="ruby-ivar">@optional_fields</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.sreg.optional'</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'openid.sreg.optional'</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>) <span class="ruby-operator">:</span> []
112:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">trust_profile_chosen?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 96</span>
 96:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">trust_profile_chosen?</span>
 97:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:trust_profile</span>]
 98:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] = <span class="ruby-value str">'Please create a trust profile.'</span>
 99:       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'profiles'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>) 
100:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
101:     <span class="ruby-keyword kw">end</span>
102:     <span class="ruby-keyword kw">true</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">trust_request_param_exists?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 87</span>
87:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">trust_request_param_exists?</span>
88:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:query</span>]
89:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] = <span class="ruby-value str">'Sorry, this trust request has already expired.'</span>
90:       <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'account'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'welcome'</span>)
91:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
92:     <span class="ruby-keyword kw">end</span>
93:     <span class="ruby-keyword kw">true</span>
94:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <a href="#M000073" class="method-signature">
          <span class="method-name">user_owns_identity_url?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the current user owns @req.identity_url
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000073-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000073-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 140</span>
140:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">user_owns_identity_url?</span>
141:     <span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">login</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">extract_identity</span>(<span class="ruby-ivar">@req</span>.<span class="ruby-identifier">identity_url</span>)
142:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000084" class="method-detail">
        <a name="M000084"></a>

        <div class="method-heading">
          <a href="#M000084" class="method-signature">
          <span class="method-name">verify_current_user_owns_identity_url</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns true if the <em>current_user</em> owns the identity url. Identity
urls follow the format of <a
href="http://idp.com/user/[user_login">idp.com/user/[user_login</a>] and <a
href="http://[user_login].idp.com">[user_login].idp.com</a>/
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000084-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000084-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 239</span>
239:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">verify_current_user_owns_identity_url</span>
240:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@req</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">OpenID</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span><span class="ruby-operator">::</span><span class="ruby-constant">CheckIDRequest</span>) <span class="ruby-operator">||</span> <span class="ruby-ivar">@req</span>.<span class="ruby-identifier">mode</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'checkid_immediate'</span> <span class="ruby-operator">||</span>
241:       <span class="ruby-identifier">user_owns_identity_url?</span>
242:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
243:     <span class="ruby-keyword kw">else</span>
244:       <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:error</span>] = <span class="ruby-node">&quot;You do not own #{CGI.escapeHTML(params['openid.identity'])}.&quot;</span> <span class="ruby-operator">+</span>
245:                     <span class="ruby-value str">&quot; Please login with an account that owns this url.&quot;</span>
246:       <span class="ruby-identifier">store_location</span>
247:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'account'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'login'</span> <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
248:     <span class="ruby-keyword kw">end</span>
249:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000098" class="method-detail">
        <a name="M000098"></a>

        <div class="method-heading">
          <a href="#M000098" class="method-signature">
          <span class="method-name">xml_profile_list</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses and executes an xml list profile command.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000098-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000098-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 490</span>
490:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">xml_profile_list</span>(<span class="ruby-identifier">xml</span>) 
491:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span> 
492:       <span class="ruby-identifier">profiles</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">title</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>) 
493:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;Response&gt;#{profiles}&lt;/Response&gt;&quot;</span>) 
494:     <span class="ruby-keyword kw">end</span> 
495:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;Response&gt;Internal Error&lt;/Response&gt;'</span> 
496:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000100" class="method-detail">
        <a name="M000100"></a>

        <div class="method-heading">
          <a href="#M000100" class="method-signature">
          <span class="method-name">xml_query_profile</span><span class="method-args">(xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses and executes an xml query profile command.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">xml:</td><td>The raw xml post data.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000100-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000100-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/server_controller.rb, line 508</span>
508:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">xml_query_profile</span>(<span class="ruby-identifier">xml</span>) 
509:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span> 
510:       <span class="ruby-identifier">profile_name</span> = (<span class="ruby-identifier">xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">get_elements</span>(<span class="ruby-value str">'AccessProfile'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">empty</span>).<span class="ruby-identifier">text</span> 
511:       <span class="ruby-identifier">profile_name</span> = <span class="ruby-value str">'public'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">profile_name</span> 
512:       <span class="ruby-ivar">@profile</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">profiles</span>.<span class="ruby-identifier">find_by_title</span>(<span class="ruby-identifier">profile_name</span>) 
513:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&lt;Response&gt;bad profile&lt;/Response&gt;&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@profile</span> 
514:        
515:       <span class="ruby-identifier">properties</span> = <span class="ruby-ivar">@profile</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">property_type</span>.<span class="ruby-identifier">title</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>) 
516:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;Response&gt;#{properties}&lt;/Response&gt;&quot;</span>) 
517:     <span class="ruby-keyword kw">end</span> 
518:     <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&lt;Response&gt;Internal Error&lt;/Response&gt;&quot;</span>) 
519:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>